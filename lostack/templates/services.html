{% extends "core.html" %}

{% block title %}Services - LoStack Admin{% endblock %}
{% block page_title %}LoStack Services{% endblock %}

{% block nav_actions %}
<div class="btn-group" role="group">
  <a href="{{ url_for('service_new') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle me-1"></i>
    New Service
  </a>
  <a href="{{ url_for('service_import') }}" class="btn btn-outline-primary">
    <i class="bi bi-upload me-1"></i>
    Import Config
  </a>
</div>
{% endblock %}

{% block content %}
<style>
  .service-card {
    max-height: 400px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease;
  }
  
  .service-card .card-body {
    overflow-y: auto;
    flex-grow: 1;
  }
  
  .service-card .card-body::-webkit-scrollbar {
    width: 8px;
  }
  
  .service-card .card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .service-card .card-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  .service-card .card-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
</style>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteServiceModal" tabindex="-1" aria-labelledby="deleteServiceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteServiceModalLabel">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Confirm Service Deletion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Are you sure you want to delete this service?</strong></p>
        <p class="mb-3">Uninstalling a service will:</p>
        <ol class="mb-3">
          <li>Delete the service from the LoStack database</li>
          <li>Remove the router, middleware, and service from the dynamic Traefik config</li>
          <li>Kill all service containers</li>
          <li>Remove all service containers</li>
          <li>Remove the services from dynamic compose</li>
        </ol>
        <p class="mb-0"><strong>It will not:</strong></p>
        <ul class="mb-0">
          <li>Delete persistent data saved in volumes</li>
          <li>Purge image data from Docker builder</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-1"></i>
          Yes, Delete Service
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <!-- Services Summary -->
    <div class="row mb-4">
      <div class="col-4">
        <div class="card shadow-sm bg-primary text-white">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <h4 class="mb-0">{{ services|length }}</h4>
                <p class="mb-0 small">Total</p>
              </div>
              <i class="bi bi-list-ul display-6 opacity-50"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="col-4">
        <div class="card shadow-sm bg-success text-white">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <h4 class="mb-0">{{ services|selectattr("enabled")|list|length }}</h4>
                <p class="mb-0 small">Enabled</p>
              </div>
              <i class="bi bi-check-circle display-6 opacity-50"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="col-4">
        <div class="card shadow-sm bg-secondary text-white">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <h4 class="mb-0">{{ services|rejectattr("enabled")|list|length }}</h4>
                <p class="mb-0 small">Disabled</p>
              </div>
              <i class="bi bi-pause-circle display-6 opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if services %}
    <div class="row">
      {% for service in services %}
      <div class="col-lg-6 col-xxl-4 mb-4">
        <div class="card shadow service-card {% if not service.enabled %}service-disabled{% endif %}">
          <div
            class="card-header {% if service.enabled %}{% if service.automatic %}bg-primary text-white{% else %}bg-success text-white{% endif %}{% else %}bg-secondary text-white{% endif %}">
            <!-- Service Header -->
            <div class="d-flex align-items-start justify-content-between">
              <label class="form-check-label fw-bold" for="service-{{ service.id }}">
                {{ service.display_name_or_name }}
              </label>
              
              <!-- Header Actions -->
              <div class="d-flex gap-2 align-items-center">
                <!-- Service Status Pills -->
                <div class="service-status d-flex gap-2">
                  {% if service.enabled %}
                  <span class="badge rounded-pill bg-light text-success border border-success">
                    <i class="bi bi-check-circle me-1"></i>
                    Enabled
                  </span>
                  {% else %}
                  <span class="badge rounded-pill bg-light text-secondary border border-secondary">
                    <i class="bi bi-pause-circle me-1"></i>
                    Disabled
                  </span>
                  {% endif %}
                  
                  <!-- Container Status Pill -->
                  {% set container_statuses = [] %}
                  {% for name in service.names.split(",") %}
                    {% set container = containers.get(name.strip(), {}) or {} %}
                    {% set status = container.get("Status", "Not Found") %}
                    {% if 'Up' in status %}
                      {% set _ = container_statuses.append(true) %}
                    {% else %}
                      {% set _ = container_statuses.append(false) %}
                    {% endif %}
                  {% endfor %}
                  
                  {% set total_containers = container_statuses|length %}
                  {% set up_containers = container_statuses|select|list|length %}
                  
                  {% if up_containers == total_containers and total_containers > 0 %}
                  <span class="badge rounded-pill bg-light text-primary border border-primary">
                    <i class="bi bi-hdd-stack me-1"></i>
                    All Up
                  </span>
                  {% else %}
                  <span class="badge rounded-pill bg-light text-secondary border border-secondary">
                    <i class="bi bi-hdd-stack me-1"></i>
                    {{ up_containers }}/{{ total_containers }} Up
                  </span>
                  {% endif %}
                </div>


              </div>
            </div>
          </div>

          <div class="card-body">
            <!-- Service Management -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><strong>Service</strong></h6>
                <div class="d-flex gap-2 flex-wrap">
                  <!-- Delete Service Button -->
                  <button class="btn btn-sm btn-outline-danger btn-action" 
                          onclick="showDeleteConfirmation({{ service.id }}, '{{ service.display_name_or_name }}', '{{ url_for("sablier_service_action", service_id=service.id, action="remove") }}')"
                          title="Delete Service">
                    <i class="bi bi-trash3 me-1"></i>
                    Delete Service
                  </button>
                </div>
              </div>
              <div class="small text-muted">
                <div class="row g-2">
                  <div class="col-6">
                    <strong>Service Name:</strong><br>
                    <code class="text-primary">{{ service.display_name_or_name }}</code>
                  </div>
                  <div class="col-6">
                    <strong>Status:</strong><br>
                    <span class="badge rounded-pill {% if service.enabled %}bg-success{% else %}bg-secondary{% endif %}">
                      <i class="bi bi-{{ 'check-circle' if service.enabled else 'pause-circle' }} me-1"></i>
                      {{ 'Enabled' if service.enabled else 'Disabled' }}
                    </span>
                  </div>
                  <div class="col-12">
                    <strong>Service URL:</strong><br>
                    <code class="small text-break">
                        <a href="https://{{ service.name }}.{{ request.host.split('.', 1)[1]}}/" target="_blank" class="text-decoration-none">
                          https://{{ service.name }}.{{ request.host.split('.', 1)[1]}}/
                          <i class="bi bi-box-arrow-up-right ms-1"></i>
                        </a>
                    </code>
                  </div>
                </div>
              </div>
            </div>

            <hr class="text-black-50">

            <!-- Service Configuration -->
            <!-- Router Configuration -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><strong>Router Configuration</strong></h6>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-sm btn-outline-{{ 'success' if not service.enabled else 'secondary' }} btn-action"
                    onclick="toggleService({{ service.id }})"
                    title="{{ 'Enable' if not service.enabled else 'Disable' }} autostart">
                    <i class="bi bi-{{ 'play' if not service.enabled else 'pause' }}"></i>
                  </button>

                  <!-- Edit -->
                  <a href="{{ url_for('service_edit', service_id=service.id) }}"
                    class="btn btn-sm btn-outline-primary btn-action" title="Edit autostart">
                    <i class="bi bi-pencil"></i>
                  </a>

                  <!-- Delete -->
                  <a href="{{ url_for('service_delete', service_id=service.id) }}"
                    class="btn btn-sm btn-outline-danger btn-action" title="Delete router">
                    <i class="bi bi-trash"></i>
                  </a>
                </div>
              </div>
              <div class="small text-muted">
                <div class="row g-2">
                  <div class="col-6">
                    <strong>Primary Service:</strong><br>
                    <code class="text-primary">{{ service.name }}</code>
                  </div>
                  <div class="col-6">
                    <strong>Router Port:</strong><br>
                    <code>{{ service.port }}</code>
                  </div>
                  <div class="col-6">
                    <strong>Duration:</strong><br>
                    {{ service.session_duration }}
                  </div>
                  <div class="col-6">
                    <strong>Theme:</strong><br>
                    {{ service.theme|title }}
                  </div>
                </div>
              </div>
            </div>

            <hr class="text-black-50">

            <!-- Docker Containers -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><strong>Containers</strong></h6>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-sm btn-outline-success btn-action" 
                          onclick="serviceActionWithTerminal('{{ url_for("sablier_service_action", service_id=service.id, action="up") }}', '{{ service.display_name_or_name }} - Start')"
                          title="Up all containers">
                    <i class="bi bi-play"></i>
                  </button>

                  <!-- Stop -->
                  <button class="btn btn-sm btn-outline-secondary btn-action" 
                          onclick="serviceActionWithTerminal('{{ url_for("sablier_service_action", service_id=service.id, action="stop") }}', '{{ service.display_name_or_name }} - Stop')"
                          title="Stop all containers">
                    <i class="bi bi-stop"></i>
                  </button>

                  <!-- Delete -->
                  <button class="btn btn-sm btn-outline-danger btn-action" 
                          onclick="serviceActionWithTerminal('{{ url_for("sablier_service_action", service_id=service.id, action="remove") }}', '{{ service.display_name_or_name }} - Remove')"
                          title="Remove all containers">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <div class="small text-muted">
                {% for name in service.names.split(",") %}
                  {% set container = containers.get(name, {}) or {} %}
                  {% set status = container.get("Status", "Not Found") %}
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <p class="text-truncate {% if 'Up' in status %}text-success{% elif 'Starting' in status %}text-primary{% elif 'Exited' in status %}text-muted{% endif %} me-2 my-0 mx-0">• {{ name }}</p>
                    <span class="badge rounded-pill {% if 'Up' in status %}bg-success{% elif 'Starting' in status %}bg-primary{% elif 'Exited' in status %}bg-secondary{% else %}bg-danger{% endif %}">
                      {{ status }}
                    </span>
                  </div>
                {% endfor %}
              </div>
            </div>

            <!-- Ports Section -->
            {% set ports_list = [] %}
            {% for name in service.names.split(",") %}
              {% set container = containers.get(name.strip(), {}) %}
              {% if container and container.get("Ports") %}
                {{ ports_list.append(name) or "" }}
              {% endif %}
            {% endfor %}

            {% if ports_list|length > 0 %}
            <hr class="text-black-50">
            <div class="mb-3">
              <h6 class="mb-2"><strong>Ports</strong></h6>
              <div class="small text-muted">
                <div class="row mb-1">
                  <div class="col-3"><strong>IP</strong></div>
                  <div class="col-3"><strong>External</strong></div>
                  <div class="col-3"><strong>Internal</strong></div>
                  <div class="col-3"><strong>Type</strong></div>
                </div>
                {% for name in service.names.split(",") %}
                  {% set container = containers.get(name.strip(), {}) %}
                  {% if container and container.get("Ports") %}
                    <div class="mb-2">
                      <code class="text-truncate text-muted fw-bold d-block mb-1">{{ name.strip() }}</code>
                      {% for port in container.get("Ports", []) %}
                        <div class="row align-items-center">
                          <div class="col-3">
                            <span class="text-muted small">{{ port.get("IP", "0.0.0.0") }}</span>
                          </div>
                          <div class="col-3">
                            <span class="text-muted small">{{ port.get("PublicPort", "-") }}</span>
                          </div>
                          <div class="col-3">
                            <span class="text-muted small">{{ port.get("PrivatePort", "-") }}</span>
                          </div>
                          <div class="col-3">
                            <span class="badge bg-info small">{{ port.get("Type", "").upper() }}</span>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Volumes Section -->
            {% set volumes_list = [] %}
            {% for name in service.names.split(",") %}
              {% set mounts = (containers.get(name, {}) or {}).get("Mounts", []) %}
              {% for mount in mounts %}
                {% if mount["Type"] == "bind" %}
                  {% set _ = volumes_list.append(mount) %}
                {% endif %}
              {% endfor %}
            {% endfor %}

            {% if volumes_list|length > 0 %}
            <hr class="text-black-50">
            <div class="mb-3">
              <h6 class="mb-2"><strong>Volumes</strong></h6>
              <div class="small text-muted">
                {% for name in service.names.split(",") %}
                  {% set mounts = containers.get(name, {}).get("Mounts", []) %}
                  {% if mounts %}
                    <div class="mb-2">
                      <code class="text-truncate text-muted fw-bold">{{ name }}</code>
                      {% for mount in mounts %}
                        {% if mount["Type"] == "bind" %}
                          <div class="d-flex justify-content-between align-items-center">
                            <p class="text-truncate text-muted text-sm px-0 py-0 my-0 fst-italic flex-grow-1"> • {{ mount["Source"] }}</p>
                            <div class="d-flex align-items-center">
                              <span class="text-truncate text-muted text-sm px-0 py-0 ms-3 me-1 fst-italic">{{ mount["Destination"] }}</span>
                              <span class="badge rounded-pill bg-dark">
                                {{ mount["Mode"]|upper }}
                              </span>
                            </div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            {% endif %}

          </div>

        </div>
      </div>
      {% endfor %}
    </div>


    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
      <div class="card">
        <div class="card-body py-5">
          <i class="bi bi-inbox display-1 text-muted mb-3"></i>
          <h4 class="text-muted mb-3">No Services Configured</h4>
          <p class="text-muted mb-4">
            Get started by creating your first LoStack service configuration.
          </p>
          <a href="{{ url_for('service_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>
            Create Your First Service
          </a>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Enhanced service management functionality
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });

  // Service card animations
  const serviceCards = document.querySelectorAll('.service-card');
  serviceCards.forEach(card => {
    card.addEventListener('mouseenter', function () {
      this.style.transform = 'translateY(-5px)';
    });

    card.addEventListener('mouseleave', function () {
      this.style.transform = 'translateY(0)';
    });
  });

  // Function to launch service actions with terminal modal
  function serviceActionWithTerminal(streamUrl, actionTitle) {
    // Update the terminal modal title
    const modalTitle = document.getElementById('terminalModalLabel');
    if (modalTitle) {
      modalTitle.innerHTML = `<i class="bi bi-terminal me-2"></i>${actionTitle}`;
    }
    
    // Launch the terminal modal with the stream
    launchTerminalModal(streamUrl);
  }

  // Variables to store delete action details
  let deleteServiceUrl = null;
  let deleteServiceName = null;

  // Function to show delete confirmation modal
  function showDeleteConfirmation(serviceId, serviceName, deleteUrl) {
    deleteServiceUrl = deleteUrl;
    deleteServiceName = serviceName;
    
    // Update modal title with service name
    const modalLabel = document.getElementById('deleteServiceModalLabel');
    modalLabel.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Delete "${serviceName}"`;
    
    // Show the modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteServiceModal'));
    deleteModal.show();
  }

  // Handle delete confirmation
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteServiceUrl) {
      // Close the modal
      const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteServiceModal'));
      deleteModal.hide();
      
      // Execute the delete action with terminal
      serviceActionWithTerminal(deleteServiceUrl, `${deleteServiceName} - Delete Service`);
      
      // Reset variables
      deleteServiceUrl = null;
      deleteServiceName = null;
    }
  });

  // Add visual feedback when hovering over action buttons
  document.addEventListener('DOMContentLoaded', function() {
    const actionButtons = document.querySelectorAll('.btn-action');
    
    actionButtons.forEach(button => {
      button.addEventListener('mouseenter', function() {
        this.classList.add('shadow-sm');
      });
      
      button.addEventListener('mouseleave', function() {
        this.classList.remove('shadow-sm');
      });
    });
  });
</script>
{% endblock %}